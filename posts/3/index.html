<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title> ColdFusion Service Pinger | Barrett Otte</title>
<link rel=canonical href=https://barrettotte.github.com/posts/3/>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet href=/css/styles.c05d68261bf086a9d7713c4f8a6215a3601608e267a816a7ee58f139b3d1aae51222aae2081c8e0c6bd35e1334773b7a16283022f31f92afd93bb37e5e822e66.css integrity="sha512-wF1oJhvwhqnXcTxPimIVo2AWCOJnqBan7ljxObPRquUSIqriCByODGvTXhM0dzt6FigwIvMfkq/ZO7N+XoIuZg==">
<link rel=stylesheet href=/lib/font-awesome/css/all.min.css>
<link rel=stylesheet href=/css/custom.css>
<link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=icon href=/img/favicon.svg>
</head>
<body class="max-width mx-auto px3 py5 ltr">
<div class="content index py4"><header id=header>
<div id=title>
<h1><a href=https://barrettotte.github.com>Barrett Otte</a></h1>
<div id=subtitle>
<div class=subtitle-item><a href=https://github.com/barrettotte>Software Engineer</a></div>
<div class=subtitle-item>Tinkerer</div>
<div class=subtitle-item><a href=https://anilist.co/user/barrettotte/>Loser</a></div>
</div>
</div>
<div id=nav>
<div class=nav-item>
<a href=/>Home</a>
</div>
<div class=nav-item>
<a href=/projects>Projects</a>
</div>
<div class=nav-item>
<a class=active href=/posts>Posts</a>
</div>
<div class=nav-item>
<a href=/about>About</a>
</div>
<div class=nav-item>
<a href=https://raw.githubusercontent.com/barrettotte/Resume/master/barrettotte-resume.pdf>Resume</a>
</div>
<div class=nav-item>
<a href=/misc>Misc</a>
</div>
</div>
</header>
<article class=post>
<header>
<h1 class=posttitle>ColdFusion Service Pinger</h1>
<div class=meta>
<span class=author>
<span>Barrett Otte</span>
</span>
<div class=postdate>
<time datetime="2018-12-01 00:00:00 +0000 UTC">2018-12-01</time>
</div>
<div class=article-read-time>
<i class="far fa-clock"></i>
2 minute read
</div>
</div>
</header>
<div class=content>
<p>At my job sometimes a few of the legacy services' health in the qa/dev environment decays and there are no robust health checks in place.
So, one morning I coded up a quick and dirty page that product owners could hit to get a sanity check when they were checking features.</p>
<p>In summary, this ColdFusion page hits each listed service in the JSON and uses multithreading.
This was the first time I ever messed around with multithreading in ColdFusion; It was easier than I thought.</p>
<p><code>index.cfm</code></p>
<pre tabindex=0><code>&lt;cfscript&gt;
    serviceTester = new serviceTester();
    writeOutput('
        &lt;h1&gt;Web Service Tester&lt;/h1&gt;
        &lt;hr/&gt;
        &lt;p&gt;Very basic method to check web services. &lt;b&gt;Multiple runs are suggested&lt;/b&gt;&lt;/p&gt;
        &lt;form&gt;
            #serviceTester.process()#
            &lt;br&gt;
            &lt;input type=&quot;submit&quot; value=&quot;Retry&quot;&gt;
        &lt;/form&gt;
        &lt;br&gt;
        &lt;p&gt;If all services are OK and dev still is not working, 
            &lt;b&gt;then dev most likely needs to be restarted.&lt;/b&gt;
        &lt;/p&gt;
    ');
&lt;/cfscript&gt;
</code></pre><br>
<p><code>serviceTester.cfc</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span>component{
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span>    public serviceTester function init(){
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>        local.url = cgi.SERVER_NAME &amp; replace(cgi.SCRIPT_NAME, &#34;index.cfm&#34;, &#34;&#34;) &amp; &#34;serviceTester.json&#34;;
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span>        variables.config = deserializeJSON(httpGet(local.url).send().getPrefix().FileContent);
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>        return this;
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>    }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>    public string function process(){
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>        var outHTML = &#34;&#34;;
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>        var size = arrayLen(variables.config.targets);
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>        var threadList = &#34;&#34;;
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>        this.threadOutput = arrayNew(1); //variables scope makes this work
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span>        for(var i = 1; i &lt;= size;  i++){
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span>            thread action=&#34;run&#34; name=&#34;thread#i#&#34; index=i payload=variables.config.targets[i] {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span>                this.threadOutput[index] = makeRow(payload);
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span>            }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span>            listAppend(threadList, &#34;thread#i#&#34;);
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span>        threadJoin(threadList, 15000);
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span>        savecontent variable=&#39;outHTML&#39;{
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span>            writeOutput(&#34;&lt;table style=&#39;border-collapse:separate; border-spacing:25px 0;&#39;&gt;&#34;);
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span>            for(var i = 1; i &lt;= size; i++){
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span>                writeOutput(this.threadOutput[i]);
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span>            }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span>            writeOutput(&#34;&lt;/table&gt;&#34;);
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span>        return outHTML;
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span>    }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span>    private string function makeCell(required any content, numeric padding=10, string color=&#34;black&#34;){
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span>        return &#34;&lt;td style=&#39;padding: #arguments.padding#px 0; color:#arguments.color#&#39;&gt;&#34; &amp; arguments.content &amp; &#34;&lt;/td&gt;&#34;;
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span>    }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span>    private string function makeRow(required struct payload){
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span>        var response = httpGet(payload.url).send().getPrefix()[&#34;Statuscode&#34;];
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span>        var status = response == &#34;200&#34; ? {&#34;text&#34;:&#34;OK&#34;,&#34;color&#34;:&#34;green&#34;}:{&#34;text&#34;:&#34;DOWN&#34;,&#34;color&#34;:&#34;red&#34;};
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span>        var outHTML = &#34;&lt;tr&gt;&#34;
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span>            &amp; makeCell(content: &#39;&lt;a href=&#34;&#39; &amp; payload.url &amp; &#39;&#34;&gt;&#39; &amp; payload.name &amp; &#39;&lt;/a&gt;&#39;)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span>            &amp; makeCell(content:&#34;. . . . . . . .&#34;, padding:2)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span>            &amp; makeCell(content:status.text, color:status.color) &amp; &#34;&lt;/tr&gt;&#34;;                    
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span>        return outHTML;
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span>    }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span>    private http function httpGet(required string reqUrl){
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span>        var httpService = new http();
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span>        var timeout = isDefined(&#34;variables.config.timeout&#34;) ? variables.config.timeout : 200;
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span>        httpService.setTimeOut(timeout);
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span>        httpService.setCharset(&#39;utf-8&#39;);
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span>        httpService.setMethod(&#34;GET&#34;);
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span>        httpService.setUrl(arguments.reqUrl);
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span>        return httpService;
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span>    }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span>}
</code></pre></div><br>
<p><code>serviceTester.json</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span>{
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span>  <span style=color:#f92672>&#34;timeout&#34;</span>: <span style=color:#ae81ff>5</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span>  <span style=color:#f92672>&#34;targets&#34;</span>: [
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>    {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Some Service&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>      <span style=color:#f92672>&#34;url&#34;</span>: <span style=color:#e6db74>&#34;http://somewhere:123&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>    },
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>    {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Some other Service&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>      <span style=color:#f92672>&#34;url&#34;</span>: <span style=color:#e6db74>&#34;http://somewhere/else:456&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>    }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>  ]
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>}
</code></pre></div>
</div>
</article>
<footer id=footer>
<div class=footer-left>
&copy; 2022
<a href=/>Barrett Otte</a>
</div>
<div class=footer-right>
<nav>
<ul>
<li>
<a class=icon target=_blank rel=noopener href=mailto:barrettotte@gmail.com>
<i class="fas fa-lg fa-envelope"></i>
</a>
</li>
<li>
<a class=icon target=_blank rel=noopener href=https://github.com/barrettotte>
<i class="fab fa-lg fa-github"></i>
</a>
</li>
<li>
<a class=icon target=_blank rel=noopener href=https://www.linkedin.com/in/barrettotte/>
<i class="fab fa-lg fa-linkedin"></i>
</a>
</li>
<li>
<a class=icon target=_blank rel=noopener href="https://news.ycombinator.com/user?id=barrettotte">
<i class="fab fa-lg fa-hacker-news-square"></i>
</a>
</li>
</ul>
</nav>
</div>
</footer>
</div>
</body>
<link rel=stylesheet href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/code-copy.js></script>
</html>